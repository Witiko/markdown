\fontfam[lm]
\hyperlinks\Blue\Blue

% Set options of the Markdown module
\_def \markdownOptions {
  contentBlocks=true,
  debugExtensions=true,
  definitionLists=true,
  fancyLists=true,
  fencedCode=true,
  hashEnumerators=true,
  inlineNotes=true,
  lineBlocks=true,
  notes=true,
  pipeTables=true,
  rawAttribute=true,
  smartEllipses=true,
  strikeThrough=true,
  subscripts=true,
  superscripts=true,
  tableCaptions=true,
  taskLists=true,
  texMathDollars=true,
  texMathDoubleBackslash=true,
  texMathSingleBackslash=true
}

% Set renderers of the Markdown module
%% Attribute Renderers
%%% TODO

%% Block Quote Renderers
\_def  \markdownRendererBlockQuoteBegin {\_begblock}
\_def  \markdownRendererBlockQuoteEnd {\_endblock}

%% Bracketed Spans Attribute Context Renderers
%%% TODO

%% Bullet List Renderers
\_def  \markdownRendererUlBegin       {\_begitems}
\_def  \markdownRendererUlBeginTight  {\_begitems \_novspaces}
\_def  \markdownRendererUlItem        {\_startitem}
\_def  \markdownRendererUlItemEnd     {\_par}
\_def  \markdownRendererUlEnd         {\_enditems}
\_def  \markdownRendererUlEndTight    {\_enditems}

%% Citations Renderers
%%% TODO

%% Code Block Renderers
\_def  \markdownRendererInputVerbatim #1{\_verbinput (-) {#1} }
\_def  \markdownRendererInputFencedCode #1#2{\_verbinput \_hisyntax{#2} (-) {#1} }

%% Code Span Renderer
\_def  \markdownRendererCodeSpan    #1{{\_ttfont #1}}

%% Code Span Attribute Context Renderers
%%% TODO

%% Content Block Renderers
%%% TODO

%% Definition List Renderers
\_def  \markdownRendererDlBegin       {\_begitems \_style d}
\_def  \markdownRendererDlBeginTight  {\_begitems \_style d \_novspaces}
\_def  \markdownRendererDlItem        {\_startitem}
\_def  \markdownRendererDlItemEnd     {\_endgroup\_par}
\_def  \markdownRendererDlDefinitionBegin {\_endgroup}
\_def  \markdownRendererDlDefinitionEnd {\_begingroup \_nl}
\_def  \markdownRendererDlEnd         {\_enditems}
\_def  \markdownRendererDlEndTight    {\_enditems}

%% Ellipsis Renderer
\_def  \markdownRendererEllipsis      {$\_ldots$}

%% Emphasis Renderers
\_def  \markdownRendererEmphasis    #1{{\_em #1}}
\_def  \markdownRendererStrongEmphasis #1{{\_bf #1}}

%% Fenced Code Attribute Context Renderers
%%% TODO

%% Fenced Div Attribute Context Renderers
%%% TODO

%% Header Attribute Context Renderers
%%% TODO

%% Heading Renderers
\_def  \markdownRendererHeadingOne  #1{\_printtit{#1}}
\_def  \markdownRendererHeadingTwo  #1{\_inchap{#1}}
\_def  \markdownRendererHeadingThree #1{\_insec{#1}}
\_def  \markdownRendererHeadingFour #1{\_insecc{#1}}
\_def  \markdownRendererHeadingFive #1{{\_bf #1}\_firstnoindent}
\_def  \markdownRendererHeadingSix  #1{#1\_firstnoindent}

%% HTML Comment Renderers
%%% TODO

%% HTML Tag and Element Renderers
%%% TODO

%% Image Renderer
\_def  \markdownRendererImage #1#2#3#4{\_inspic{#3}}

%% Image Attribute Context Renderers
%%% TODO

%% Interblock Separator Renderer
\_def  \markdownRendererInterblockSeparator {\_par}

%% Line Block Renderers
%%% TODO

%% Line Break Renderer
\_def  \markdownRendererHardLineBreak {\_nl}

%% Link Renderer
\_def  \markdownRendererLink  #1#2#3#4{\_ea\_ulink\_ea[\_expanded{#3}]{#1}}

%% Link Attribute Context Renderers
%%% TODO

%% Markdown Document Renderers
\_let  \markdownRendererDocumentBegin \_relax
\_let  \markdownRendererDocumentEnd   \_relax

%% Non-Breaking Space Renderer
\_def  \markdownRendererNbsp          {~}

%% Note Renderer
%%% TODO

%% Ordered List Renderers
\_def  \markdownRendererOlBegin       {\_begitems \_style n}
\_def  \markdownRendererOlBeginTight  {\_begitems \_style n \_novspaces}
\_def  \markdownRendererFancyOlBegin #1#2{\markdownRendererOlBegin}
\_def  \markdownRendererFancyOlBeginTight #1#2{\markdownRendererOlBeginTight}
\_def  \markdownRendererOlItem        {\_startitem}
\_def  \markdownRendererOlItemEnd     {\_par}
\_def  \markdownRendererOlItemWithNumber #1{\_itemnum=#1\_relax \_startitem}
\_let  \markdownRendererFancyOlItem   \markdownRendererOlItem
\_let  \markdownRendererFancyOlItemEnd \markdownRendererOlItemEnd
\_let  \markdownRendererFancyOlItemWithNumber \markdownRendererOlItemWithNumber
\_def  \markdownRendererOlEnd         {\_enditems}
\_def  \markdownRendererOlEndTight    {\_enditems}
\_let  \markdownRendererFancyOlEndTight \markdownRendererOlEndTight
\_let  \markdownRendererFancyOlEnd   \markdownRendererOlEnd

%% Raw Content Renderers
%%% TODO

%% Section Renderers
\_let  \markdownRendererSectionBegin  \_relax
\_let  \markdownRendererSectionEnd    \_relax

%% Replacement Character Renderers
\_def  \markdownRendererReplacementCharacter {^^^^fffd}

%% Special Character Renderers
\_edef \markdownRendererAmpersand   #1{\_csstring\&}
\_edef \markdownRendererBackslash   #1{\_csstring\\}
\_edef \markdownRendererCircumflex  #1{\_csstring\^}
\_edef \markdownRendererDollarSign  #1{\_csstring\$}
\_edef \markdownRendererHash        #1{\_csstring\#}
\_edef \markdownRendererLeftBrace   #1{\_csstring\{}
\_edef \markdownRendererPercentSign #1{\_csstring\%}
\_def  \markdownRendererPipe        #1{|}
\_edef \markdownRendererRightBrace  #1{\_csstring\}}
\_edef \markdownRendererTilde       #1{\_csstring\~}
\_def  \markdownRendererUnderscore  #1{_}

%% Strike-Through Renderer
%%% TODO

%% Subscript Renderer
%%% TODO

%% Superscript Renderer
%%% TODO

%% Table Renderer
%%% TODO

%% TeX Math Renderers
%%% TODO

%% Thematic Break Renderer
\_def  \markdownRendererThematicBreak {\_hrule}

%% Tickbox Renderers
%%% TODO

%% YAML Metadata Renderers
\_let  \markdownRendererJekyllDataBegin \_relax
\_let  \markdownRendererJekyllDataEnd \_relax
\_def  \markdownRendererJekyllDataMappingBegin #1#2{}
\_let  \markdownRendererJekyllDataMappingEnd \_relax
\_def  \markdownRendererJekyllDataSequenceBegin #1#2{}
\_let  \markdownRendererJekyllDataSequenceEnd \_relax
\_def  \markdownRendererJekyllDataBoolean #1#2{}
\_def  \markdownRendererJekyllDataNumber #1#2{}
\_def  \markdownRendererJekyllDataString #1#2{}
\_def  \markdownRendererJekyllDataEmpty #1{}

% Load the Markdown module and set TeX macros for the Markdown module
\_directlua{
  kpse = require("kpse")
  kpse.set_program_name("luatex")
  markdown = require("markdown")
}

\_eoldef \markdownBegin #1{% #1 includes the end of the current line, parameters can be here
   \_def\_markdownParams{#1}%
   \_bgroup \_setverb \_savemathsb \_endlinechar=`\^^J
   \_markdownBeginA
}

\_ea\_def \_ea\_markdownBeginA \_ea#\_ea1\_csstring\\markdownEnd#2^^J{%
  \_restoremathsb \_egroup
  \_bgroup
  \_catcode`\%=12\_relax
  \_catcode`\#=12\_relax
  \_directlua {
    local input = "\_luaescapestring{#1}"
    local defaultOptions = {\markdownOptions}
    local options = {\_markdownParams}
    setmetatable(
      options,
      {
        __index__ = function(_, key)
          local value = defaultOptions[key]
          return value
        end
      }
    )
    local convert = markdown.new(options)
    local output = convert(input)
    tex.print(output)
  }%
  \_egroup
}

% Set the document metadata using a YAML metadata block
\markdownBegin hybrid=true,jekyllData=true
---
title:  An Example *Markdown* Document
author: Vít Novotný
date:   \today
---
\markdownEnd

\bye
