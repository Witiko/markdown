\fontfam[lm]
\hyperlinks\Blue\Blue

% Set options of the Markdown module.
\_def \markdownOptions {
  contentBlocks=true,
  debugExtensions=true,
  definitionLists=true,
  fancyLists=true,
  fencedCode=true,
  hashEnumerators=true,
  inlineNotes=true,
  lineBlocks=true,
  notes=true,
  pipeTables=true,
  rawAttribute=true,
  smartEllipses=true,
  strikeThrough=true,
  subscripts=true,
  superscripts=true,
  tableCaptions=true,
  taskLists=true,
  texMathDollars=true,
  texMathDoubleBackslash=true,
  texMathSingleBackslash=true
}

% Set renderers of the Markdown module.
\_edef \markdownRendererAmpersand   #1{\_csstring\&}
\_edef \markdownRendererBackslash   #1{\_csstring\\}
\_edef \markdownRendererCircumflex  #1{\_csstring\^}
\_edef \markdownRendererDollarSign  #1{\_csstring\$}
\_edef \markdownRendererHash        #1{\_csstring\#}
\_edef \markdownRendererLeftBrace   #1{\_csstring\{}
\_edef \markdownRendererPercentSign #1{\_csstring\%}
\_edef \markdownRendererPipe        #1{|}
\_edef \markdownRendererRightBrace  #1{\_csstring\}}
\_edef \markdownRendererTilde       #1{\_csstring\~}
\_edef \markdownRendererUnderscore  #1{_}

\_def\markdownRendererLink  #1#2#3#4{\_ea\_ulink\_ea[\_expanded{#3}]{#1}}

\_def \markdownRendererAttributeIdentifier #1{}
\_def \markdownRendererAttributeClassName  #1{}
\_def \markdownRendererAttributeKeyValue   #1#2{}

\_def \markdownRendererUlBegin      {\_begitems}
\_def \markdownRendererUlBeginTight {\_begitems \_novspaces}
\_def \markdownRendererUlEnd        {\_enditems}
\_def \markdownRendererUlEndTight   {\_enditems}
\_def \markdownRendererUlItem       {\_startitem}
\_def \markdownRendererUlItemEnd    {\_par}

\_def \markdownRendererInterblockSeparator {\_par}

\_def \markdownRendererInputVerbatim    #1{\_verbinput (-) {#1} }
\_def \markdownRendererInputFencedCode  #1#2{\_verbinput \hisyntax{#2} (-) {#1} }

\_def \markdownRendererCodeSpan         #1{{\_ttfont #1}}

\_let \markdownRendererDocumentBegin   \_relax
\_let \markdownRendererDocumentEnd     \_relax
\_def \markdownRendererBlockQuoteBegin {\_begblock}
\_def \markdownRendererBlockQuoteEnd   {\_endblock}

\_def \markdownRendererEmphasis        #1{{\_em #1}}

% Load the Markdown module and set TeX macros for the Markdown module.
\_directlua{
  kpse = pcall(require, "kpse")
  kpse.set_program_name("luatex")
  markdown = require("markdown")
}

\_def \_markdownInput #1{
  \_bgroup
  \_catcode`\%=12\_relax
  \_catcode`\#=12\_relax
  \_directlua{#1}%
  \_egroup
}

\_def \markdownInput #1{% #1 contains the filename of the Markdown document.
  \_def \_tmpa {
    local file = assert(io.open("\_luaescapestring{#1}", "r"))
    local input = assert(file:read("*a"))
    assert(file:close())
    local options = {\markdownOptions}
    local convert = markdown.new(options)
    local output = convert(input)
    tex.print(output)
  }%
  \_ea\_markdownInput\_ea{\_tmpa}%
}

\_eoldef \markdownBegin #1{% #1 includes the end of the current line, parameters can be here
   \_def\_markdownParams{#1}%
   \_bgroup \_setverb \_savemathsb \_endlinechar=`\^^J
   \_markdownBeginA
}
\_ea\_def \_ea\_markdownBeginA \_ea#\_ea1\_csstring\\markdownEnd#2^^J{%
  \_restoremathsb \_egroup
  \_def \_tmpa {
    local defaultOptions = {\markdownOptions}
    local options = {\_markdownParams}
    setmetatable(
      options,
      {
        __index__ = function(_, key)
          local value = defaultOptions[key]
          return value
        end
      }
    )
    local convert = markdown.new(options)
    local output = convert(input)
    tex.print(output)
  }%
  \_ea\_markdownInput\_ea{\_tmpa}%
}

% Set the document metadata using a YAML metadata block.
\markdownBegin hybrid=true
---
title:  An Example *Markdown* Document
author: Vít Novotný
date:   \today
---
\markdownEnd

% Typeset the document `example.md` by letting the Markdown package handle
% the conversion internally.
\markdownInput{./example.md}

% Typeset the document `example.tex` that we prepared separately using the
% Lua command-line interface of the Markdown package and that contains a
% plain TeX representation of the document `example.md`.
\_bgroup
\_catcode`\%=12\_relax
\_catcode`\#=12\_relax
\_input example.tex\relax
\_directlua{#1}%
\_egroup

% Typeset some further examples with inline markdown text.
\markdownBegin
Here are some non-ASCII characters: *ěščřžýáíé*.
\markdownEnd

\bye
